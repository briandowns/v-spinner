module spinner

import os
import sync
import term
import time

// spinner maintains the state for the spinner.
@[noinit]
struct Spinner {
mut:
	mu                sync.Mutex
	char_set          []string
	delay             time.Duration
	prefix            string
	suffix            string
	final_message     string
	last_output_plain string
	stop_chan         chan bool
	active            bool
	hide_cursor       bool
}

// Spinner.new creates a new value with the given
// character set.
pub fn Spinner.new(char_set int) Spinner {
	mut mu := sync.new_mutex()
	mu.init()

	return Spinner{
		mu: mu
		char_set: character_sets[char_set].clone()
		delay: 100 * time.millisecond
		hide_cursor: false
		active: false
	}
}

// set_hide_cursor sets the given value to hide or
// not hide the cursor.
pub fn (mut s Spinner) set_hide_cursor(hide bool) {
	s.mu.@lock()
	s.hide_cursor = hide
	s.mu.unlock()
}

// set_delay sets the delay to the given value.
pub fn (mut s Spinner) set_delay(delay time.Duration) {
	s.mu.@lock()
	s.delay = delay
	s.mu.unlock()
}

// set_final_messagefm sets the final message field with
// the given value.
pub fn (mut s Spinner) set_final_message(fm string) {
	s.mu.@lock()
	s.final_message = fm
	s.mu.unlock()
}

// start starts the spinner.
pub fn (mut s Spinner) start() {
	s.mu.@lock()

	if s.active || os.is_atty(os.stdout().fd) != 1 {
		s.mu.unlock()
		return
	}

	if s.hide_cursor {
		term.hide_cursor()
	}

	s.active = true
	s.mu.unlock()

	spawn fn (s Spinner) {
		for {
			for c in s.char_set {
				select {
					_ := <-s.stop_chan {
						return
					}
					10 * time.millisecond {
						print('\r${s.prefix}${c}${s.suffix}')
						os.flush()
						time.sleep(s.delay)
					}
				}
			}
		}

		print('\n')
	}(s)
}

// stop stops the spinner.
pub fn (mut s Spinner) stop() {
	s.mu.@lock()
	defer {
		s.mu.unlock()
	}

	if s.active {
		s.active = false
		// stop the spinner

		if s.hide_cursor {
			term.show_cursor()
		}

		s.erase()

		if s.final_message != '' {
			print('\r' + s.final_message)
		}
	}
}

// restart
pub fn (mut s Spinner) restart() {
	s.stop()
	s.start()
}

pub fn (mut s Spinner) reverse() {
	s.mu.@lock()
	s.char_set.reverse_in_place()
	s.mu.unlock()
}

// erase
fn  (mut s Spinner) erase() {
	print("\r")
}

// fn main() {
// 	mut s := Spinner.new(35)
// 	s.set_hide_cursor(true)
// 	s.start()
// 	time.sleep(10 * time.second) // fake some work
// 	s.stop()

// 	println('we stopped the spinner!')
// }

const character_sets := {
	0:  ['â†', 'â†–', 'â†‘', 'â†—', 'â†’', 'â†˜', 'â†“', 'â†™']
	1:  ['â–', 'â–ƒ', 'â–„', 'â–…', 'â–†', 'â–‡', 'â–ˆ', 'â–‡', 'â–†', 'â–…', 'â–„', 'â–ƒ', 'â–']
	2:  ['â––', 'â–˜', 'â–', 'â–—']
	3:  ['â”¤', 'â”˜', 'â”´', 'â””', 'â”œ', 'â”Œ', 'â”¬', 'â”']
	4:  ['â—¢', 'â—£', 'â—¤', 'â—¥']
	5:  ['â—°', 'â—³', 'â—²', 'â—±']
	6:  ['â—´', 'â—·', 'â—¶', 'â—µ']
	7:  ['â—', 'â—“', 'â—‘', 'â—’']
	8:  ['.', 'o', 'O', '@', '*']
	9:  ['|', '/', '-', '\\']
	10: ['â—¡â—¡', 'âŠ™âŠ™', 'â— â— ']
	11: ['â£¾', 'â£½', 'â£»', 'â¢¿', 'â¡¿', 'â£Ÿ', 'â£¯', 'â£·']
	12: [">))'>", " >))'>", "  >))'>", "   >))'>", "    >))'>", "   <'((<", "  <'((<", " <'((<"]
	13: ['â ', 'â ‚', 'â „', 'â¡€', 'â¢€', 'â  ', 'â ', 'â ˆ']
	14: ['â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â ']
	15: ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r',
		's', 't', 'u', 'v', 'w', 'x', 'y', 'z']
	16: ['â–‰', 'â–Š', 'â–‹', 'â–Œ', 'â–', 'â–', 'â–', 'â–', 'â–', 'â–Œ', 'â–‹', 'â–Š', 'â–‰']
	17: ['â– ', 'â–¡', 'â–ª', 'â–«']
	18: ['â†', 'â†‘', 'â†’', 'â†“']
	19: ['â•«', 'â•ª']
	20: ['â‡', 'â‡–', 'â‡‘', 'â‡—', 'â‡’', 'â‡˜', 'â‡“', 'â‡™']
	21: ['â ', 'â ', 'â ‰', 'â ™', 'â š', 'â ’', 'â ‚', 'â ‚', 'â ’', 'â ²', 'â ´', 'â ¤', 'â „',
		'â „', 'â ¤', 'â  ', 'â  ', 'â ¤', 'â ¦', 'â –', 'â ’', 'â ', 'â ', 'â ’', 'â “', 'â ‹',
		'â ‰', 'â ˆ', 'â ˆ']
	22: ['â ˆ', 'â ‰', 'â ‹', 'â “', 'â ’', 'â ', 'â ', 'â ’', 'â –', 'â ¦', 'â ¤', 'â  ', 'â  ',
		'â ¤', 'â ¦', 'â –', 'â ’', 'â ', 'â ', 'â ’', 'â “', 'â ‹', 'â ‰', 'â ˆ']
	23: ['â ', 'â ‰', 'â ™', 'â š', 'â ’', 'â ‚', 'â ‚', 'â ’', 'â ²', 'â ´', 'â ¤', 'â „', 'â „',
		'â ¤', 'â ´', 'â ²', 'â ’', 'â ‚', 'â ‚', 'â ’', 'â š', 'â ™', 'â ‰', 'â ']
	24: ['â ‹', 'â ™', 'â š', 'â ’', 'â ‚', 'â ‚', 'â ’', 'â ²', 'â ´', 'â ¦', 'â –', 'â ’', 'â ',
		'â ', 'â ’', 'â “', 'â ‹']
	25: ['ï½¦', 'ï½§', 'ï½¨', 'ï½©', 'ï½ª', 'ï½«', 'ï½¬', 'ï½­', 'ï½®', 'ï½¯', 'ï½±', 'ï½²', 'ï½³',
		'ï½´', 'ï½µ', 'ï½¶', 'ï½·', 'ï½¸', 'ï½¹', 'ï½º', 'ï½»', 'ï½¼', 'ï½½', 'ï½¾', 'ï½¿', 'ï¾€',
		'ï¾', 'ï¾‚', 'ï¾ƒ', 'ï¾„', 'ï¾…', 'ï¾†', 'ï¾‡', 'ï¾ˆ', 'ï¾‰', 'ï¾Š', 'ï¾‹', 'ï¾Œ', 'ï¾',
		'ï¾', 'ï¾', 'ï¾', 'ï¾‘', 'ï¾’', 'ï¾“', 'ï¾”', 'ï¾•', 'ï¾–', 'ï¾—', 'ï¾˜', 'ï¾™', 'ï¾š',
		'ï¾›', 'ï¾œ', 'ï¾']
	26: ['.', '..', '...']
	27: ['â–', 'â–‚', 'â–ƒ', 'â–„', 'â–…', 'â–†', 'â–‡', 'â–ˆ', 'â–‰', 'â–Š', 'â–‹', 'â–Œ', 'â–',
		'â–', 'â–', 'â–', 'â–', 'â–', 'â–Œ', 'â–‹', 'â–Š', 'â–‰', 'â–ˆ', 'â–‡', 'â–†', 'â–…',
		'â–„', 'â–ƒ', 'â–‚', 'â–']
	28: ['.', 'o', 'O', 'Â°', 'O', 'o', '.']
	29: ['+', 'x']
	30: ['v', '<', '^', '>']
	31: ['>>--->', ' >>--->', '  >>--->', '   >>--->', '    >>--->', '    <---<<', '   <---<<',
		'  <---<<', ' <---<<', '<---<<']
	32: ['|', '||', '|||', '||||', '|||||', '|||||||', '||||||||', '|||||||', '||||||', '|||||',
		'||||', '|||', '||', '|']
	33: ['[          ]', '[=         ]', '[==        ]', '[===       ]', '[====      ]',
		'[=====     ]', '[======    ]', '[=======   ]', '[========  ]', '[========= ]',
		'[==========]']
	34: ['(*---------)', '(-*--------)', '(--*-------)', '(---*------)', '(----*-----)',
		'(-----*----)', '(------*---)', '(-------*--)', '(--------*-)', '(---------*)']
	35: ['â–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’', 'â–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’',
		'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’', 'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’',
		'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ']
	36: ['[                    ]', '[=>                  ]', '[===>                ]',
		'[=====>              ]', '[======>             ]', '[========>           ]',
		'[==========>         ]', '[============>       ]', '[==============>     ]',
		'[================>   ]', '[==================> ]', '[===================>]']
	39: ['ğŸŒ', 'ğŸŒ', 'ğŸŒ']
	40: ['â—œ', 'â—', 'â—', 'â—Ÿ']
	41: ['â¬’', 'â¬”', 'â¬“', 'â¬•']
	42: ['â¬–', 'â¬˜', 'â¬—', 'â¬™']
	43: ['[>>>          >]', '[]>>>>        []', '[]  >>>>      []', '[]    >>>>    []',
		'[]      >>>>  []', '[]        >>>>[]', '[>>          >>]']
	44: ['â™ ', 'â™£', 'â™¥', 'â™¦']
	45: ['â', 'âŸ', 'â ', 'â¡', 'â ', 'âŸ']
	46: ['  |  ', ' \\   ', '_    ', ' \\   ', '  |  ', '   / ', '    _', '   / ']
	47: ['  . . . .', '.   . . .', '. .   . .', '. . .   .', '. . . .  ', '. . . . .']
	48: [' |     ', '  /    ', '   _   ', '    \\  ', '     | ', '    \\  ', '   _   ', '  /    ']
	49: ['âº', 'â»', 'â¼', 'â½', 'â¼', 'â»']
	50: ['â–¹â–¹â–¹â–¹â–¹', 'â–¸â–¹â–¹â–¹â–¹', 'â–¹â–¸â–¹â–¹â–¹', 'â–¹â–¹â–¸â–¹â–¹',
		'â–¹â–¹â–¹â–¸â–¹', 'â–¹â–¹â–¹â–¹â–¸']
	51: ['[    ]', '[   =]', '[  ==]', '[ ===]', '[====]', '[=== ]', '[==  ]', '[=   ]']
	52: ['( â—    )', '(  â—   )', '(   â—  )', '(    â— )', '(     â—)', '(    â— )',
		'(   â—  )', '(  â—   )', '( â—    )']
	53: ['âœ¶', 'âœ¸', 'âœ¹', 'âœº', 'âœ¹', 'âœ·']
	54: ['â–|\\____________â–Œ', 'â–_|\\___________â–Œ', 'â–__|\\__________â–Œ',
		'â–___|\\_________â–Œ', 'â–____|\\________â–Œ', 'â–_____|\\_______â–Œ',
		'â–______|\\______â–Œ', 'â–_______|\\_____â–Œ', 'â–________|\\____â–Œ',
		'â–_________|\\___â–Œ', 'â–__________|\\__â–Œ', 'â–___________|\\_â–Œ',
		'â–____________|\\â–Œ', 'â–____________/|â–Œ', 'â–___________/|_â–Œ',
		'â–__________/|__â–Œ', 'â–_________/|___â–Œ', 'â–________/|____â–Œ',
		'â–_______/|_____â–Œ', 'â–______/|______â–Œ', 'â–_____/|_______â–Œ',
		'â–____/|________â–Œ', 'â–___/|_________â–Œ', 'â–__/|__________â–Œ',
		'â–_/|___________â–Œ', 'â–/|____________â–Œ']
	55: ['â–â ‚       â–Œ', 'â–â ˆ       â–Œ', 'â– â ‚      â–Œ', 'â– â        â–Œ',
		'â–  â¡€     â–Œ', 'â–  â       â–Œ', 'â–   â ‚    â–Œ', 'â–   â ˆ    â–Œ',
		'â–    â ‚   â–Œ', 'â–    â     â–Œ', 'â–     â¡€  â–Œ', 'â–     â    â–Œ',
		'â–      â ‚ â–Œ', 'â–      â ˆ â–Œ', 'â–       â ‚â–Œ', 'â–       â  â–Œ',
		'â–       â¡€â–Œ', 'â–      â   â–Œ', 'â–      â ‚ â–Œ', 'â–     â ˆ  â–Œ',
		'â–     â ‚  â–Œ', 'â–    â     â–Œ', 'â–    â¡€   â–Œ', 'â–   â      â–Œ',
		'â–   â ‚    â–Œ', 'â–  â ˆ     â–Œ', 'â–  â ‚     â–Œ', 'â– â        â–Œ',
		'â– â¡€      â–Œ', 'â–â         â–Œ']
	56: ['Â¿', '?']
	57: ['â¢¹', 'â¢º', 'â¢¼', 'â£¸', 'â£‡', 'â¡§', 'â¡—', 'â¡']
	58: ['â¢„', 'â¢‚', 'â¢', 'â¡', 'â¡ˆ', 'â¡', 'â¡ ']
	59: ['.  ', '.. ', '...', ' ..', '  .', '   ']
	60: ['.', 'o', 'O', 'Â°', 'O', 'o', '.']
	61: ['â–“', 'â–’', 'â–‘']
	62: ['â–Œ', 'â–€', 'â–', 'â–„']
	63: ['âŠ¶', 'âŠ·']
	64: ['â–ª', 'â–«']
	65: ['â–¡', 'â– ']
	66: ['â–®', 'â–¯']
	67: ['-', '=', 'â‰¡']
	68: ['d', 'q', 'p', 'b']
	69: ['âˆ™âˆ™âˆ™', 'â—âˆ™âˆ™', 'âˆ™â—âˆ™', 'âˆ™âˆ™â—', 'âˆ™âˆ™âˆ™']
	70: ['ğŸŒ‘ ', 'ğŸŒ’ ', 'ğŸŒ“ ', 'ğŸŒ” ', 'ğŸŒ• ', 'ğŸŒ– ', 'ğŸŒ— ', 'ğŸŒ˜ ']
	71: ['â˜—', 'â˜–']
	72: ['â§‡', 'â§†']
	73: ['â—‰', 'â—']
	74: ['ãŠ‚', 'ãŠ€', 'ãŠ']
	75: ['â¦¾', 'â¦¿']
	76: ['á€', 'á€']
	77: ['â–Œ', 'â–€', 'â–â–„']
	78: ['â ˆâ ', 'â ˆâ ‘', 'â ˆâ ±', 'â ˆâ¡±', 'â¢€â¡±', 'â¢„â¡±', 'â¢„â¡±', 'â¢†â¡±', 'â¢â¡±',
		'â¢â¡°', 'â¢â¡ ', 'â¢â¡€', 'â¢â ', 'â â ', 'â Šâ ']
	79: ['________', '-_______', '_-______', '__-_____', '___-____', '____-___', '_____-__',
		'______-_', '_______-', '________', '_______-', '______-_', '_____-__', '____-___',
		'___-____', '__-_____', '_-______', '-_______', '________']
	80: ['|_______', '_/______', '__-_____', '___\\____', '____|___', '_____/__', '______-_',
		'_______\\', '_______|', '______\\_', '_____-__', '____/___', '___|____', '__\\_____',
		'_-______']
	81: ['â–¡', 'â—±', 'â—§', 'â–£', 'â– ']
	82: ['â–¡', 'â—±', 'â–¨', 'â–©', 'â– ']
	83: ['â–‘', 'â–’', 'â–“', 'â–ˆ']
	84: ['â–‘', 'â–ˆ']
	85: ['âšª', 'âš«']
	86: ['â—¯', 'â¬¤']
	87: ['â–±', 'â–°']
	88: ['âŠ', 'â‹', 'âŒ', 'â', 'â', 'â', 'â', 'â‘', 'â’', 'â“']
	89: ['Â½', 'â…“', 'â…”', 'Â¼', 'Â¾', 'â…›', 'â…œ', 'â…', 'â…']
	90: ['â†', 'â†Ÿ', 'â† ', 'â†¡']
}
