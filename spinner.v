module spinner

import os
import sync
import term
import time

// spinner maintains the state for the spinner.
@[noinit]
struct Spinner {
mut:
	mu                sync.Mutex
	char_set          []string
	delay             time.Duration
	prefix            string
	suffix            string
	final_message     string
	last_output_plain string
	stop_chan         chan bool
	active            bool
	hide_cursor       bool
}

// Spinner.new creates a new value with the given
// character set.
pub fn Spinner.new(char_set int) Spinner {
	mut mu := sync.new_mutex()
	mu.init()

	return Spinner{
		mu: mu
		char_set: character_sets[char_set].clone()
		delay: 100 * time.millisecond
		hide_cursor: false
		active: false
	}
}

// set_hide_cursor sets the given value to hide or
// not hide the cursor.
pub fn (mut s Spinner) set_hide_cursor(hide bool) {
	s.mu.@lock()
	s.hide_cursor = hide
	s.mu.unlock()
}

// set_delay sets the delay to the given value.
pub fn (mut s Spinner) set_delay(delay time.Duration) {
	s.mu.@lock()
	s.delay = delay
	s.mu.unlock()
}

// set_final_messagefm sets the final message field with
// the given value.
pub fn (mut s Spinner) set_final_message(fm string) {
	s.mu.@lock()
	s.final_message = fm
	s.mu.unlock()
}

// start starts the spinner.
pub fn (mut s Spinner) start() {
	s.mu.@lock()

	if s.active || os.is_atty(os.stdout().fd) != 1 {
		s.mu.unlock()
		return
	}

	if s.hide_cursor {
		term.hide_cursor()
	}

	s.active = true
	s.mu.unlock()

	spawn fn (s Spinner) {
		for {
			for c in s.char_set {
				select {
					_ := <-s.stop_chan {
						return
					}
					10 * time.millisecond {
						print('\r${s.prefix}${c}${s.suffix}')
						os.flush()
						time.sleep(s.delay)
					}
				}
			}
		}

		print('\n')
	}(s)
}

// stop stops the spinner.
pub fn (mut s Spinner) stop() {
	s.mu.@lock()
	defer {
		s.mu.unlock()
	}

	if s.active {
		s.active = false
		// stop the spinner

		if s.hide_cursor {
			term.show_cursor()
		}

		s.erase()

		if s.final_message != '' {
			print('\r' + s.final_message)
		}
	}
}

// restart
pub fn (mut s Spinner) restart() {
	s.stop()
	s.start()
}

pub fn (mut s Spinner) reverse() {
	s.mu.@lock()
	s.char_set.reverse_in_place()
	s.mu.unlock()
}

// erase
fn  (mut s Spinner) erase() {
	print("\r")
}

// fn main() {
// 	mut s := Spinner.new(35)
// 	s.set_hide_cursor(true)
// 	s.start()
// 	time.sleep(10 * time.second) // fake some work
// 	s.stop()

// 	println('we stopped the spinner!')
// }

const character_sets := {
	0:  ['‚Üê', '‚Üñ', '‚Üë', '‚Üó', '‚Üí', '‚Üò', '‚Üì', '‚Üô']
	1:  ['‚ñÅ', '‚ñÉ', '‚ñÑ', '‚ñÖ', '‚ñÜ', '‚ñá', '‚ñà', '‚ñá', '‚ñÜ', '‚ñÖ', '‚ñÑ', '‚ñÉ', '‚ñÅ']
	2:  ['‚ññ', '‚ñò', '‚ñù', '‚ñó']
	3:  ['‚î§', '‚îò', '‚î¥', '‚îî', '‚îú', '‚îå', '‚î¨', '‚îê']
	4:  ['‚ó¢', '‚ó£', '‚ó§', '‚ó•']
	5:  ['‚ó∞', '‚ó≥', '‚ó≤', '‚ó±']
	6:  ['‚ó¥', '‚ó∑', '‚ó∂', '‚óµ']
	7:  ['‚óê', '‚óì', '‚óë', '‚óí']
	8:  ['.', 'o', 'O', '@', '*']
	9:  ['|', '/', '-', '\\']
	10: ['‚ó°‚ó°', '‚äô‚äô', '‚ó†‚ó†']
	11: ['‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑']
	12: [">))'>", " >))'>", "  >))'>", "   >))'>", "    >))'>", "   <'((<", "  <'((<", " <'((<"]
	13: ['‚†Å', '‚†Ç', '‚†Ñ', '‚°Ä', '‚¢Ä', '‚††', '‚†ê', '‚†à']
	14: ['‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è']
	15: ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r',
		's', 't', 'u', 'v', 'w', 'x', 'y', 'z']
	16: ['‚ñâ', '‚ñä', '‚ñã', '‚ñå', '‚ñç', '‚ñé', '‚ñè', '‚ñé', '‚ñç', '‚ñå', '‚ñã', '‚ñä', '‚ñâ']
	17: ['‚ñ†', '‚ñ°', '‚ñ™', '‚ñ´']
	18: ['‚Üê', '‚Üë', '‚Üí', '‚Üì']
	19: ['‚ï´', '‚ï™']
	20: ['‚áê', '‚áñ', '‚áë', '‚áó', '‚áí', '‚áò', '‚áì', '‚áô']
	21: ['‚†Å', '‚†Å', '‚†â', '‚†ô', '‚†ö', '‚†í', '‚†Ç', '‚†Ç', '‚†í', '‚†≤', '‚†¥', '‚†§', '‚†Ñ',
		'‚†Ñ', '‚†§', '‚††', '‚††', '‚†§', '‚†¶', '‚†ñ', '‚†í', '‚†ê', '‚†ê', '‚†í', '‚†ì', '‚†ã',
		'‚†â', '‚†à', '‚†à']
	22: ['‚†à', '‚†â', '‚†ã', '‚†ì', '‚†í', '‚†ê', '‚†ê', '‚†í', '‚†ñ', '‚†¶', '‚†§', '‚††', '‚††',
		'‚†§', '‚†¶', '‚†ñ', '‚†í', '‚†ê', '‚†ê', '‚†í', '‚†ì', '‚†ã', '‚†â', '‚†à']
	23: ['‚†Å', '‚†â', '‚†ô', '‚†ö', '‚†í', '‚†Ç', '‚†Ç', '‚†í', '‚†≤', '‚†¥', '‚†§', '‚†Ñ', '‚†Ñ',
		'‚†§', '‚†¥', '‚†≤', '‚†í', '‚†Ç', '‚†Ç', '‚†í', '‚†ö', '‚†ô', '‚†â', '‚†Å']
	24: ['‚†ã', '‚†ô', '‚†ö', '‚†í', '‚†Ç', '‚†Ç', '‚†í', '‚†≤', '‚†¥', '‚†¶', '‚†ñ', '‚†í', '‚†ê',
		'‚†ê', '‚†í', '‚†ì', '‚†ã']
	25: ['ÔΩ¶', 'ÔΩß', 'ÔΩ®', 'ÔΩ©', 'ÔΩ™', 'ÔΩ´', 'ÔΩ¨', 'ÔΩ≠', 'ÔΩÆ', 'ÔΩØ', 'ÔΩ±', 'ÔΩ≤', 'ÔΩ≥',
		'ÔΩ¥', 'ÔΩµ', 'ÔΩ∂', 'ÔΩ∑', 'ÔΩ∏', 'ÔΩπ', 'ÔΩ∫', 'ÔΩª', 'ÔΩº', 'ÔΩΩ', 'ÔΩæ', 'ÔΩø', 'ÔæÄ',
		'ÔæÅ', 'ÔæÇ', 'ÔæÉ', 'ÔæÑ', 'ÔæÖ', 'ÔæÜ', 'Ôæá', 'Ôæà', 'Ôæâ', 'Ôæä', 'Ôæã', 'Ôæå', 'Ôæç',
		'Ôæé', 'Ôæè', 'Ôæê', 'Ôæë', 'Ôæí', 'Ôæì', 'Ôæî', 'Ôæï', 'Ôæñ', 'Ôæó', 'Ôæò', 'Ôæô', 'Ôæö',
		'Ôæõ', 'Ôæú', 'Ôæù']
	26: ['.', '..', '...']
	27: ['‚ñÅ', '‚ñÇ', '‚ñÉ', '‚ñÑ', '‚ñÖ', '‚ñÜ', '‚ñá', '‚ñà', '‚ñâ', '‚ñä', '‚ñã', '‚ñå', '‚ñç',
		'‚ñé', '‚ñè', '‚ñè', '‚ñé', '‚ñç', '‚ñå', '‚ñã', '‚ñä', '‚ñâ', '‚ñà', '‚ñá', '‚ñÜ', '‚ñÖ',
		'‚ñÑ', '‚ñÉ', '‚ñÇ', '‚ñÅ']
	28: ['.', 'o', 'O', '¬∞', 'O', 'o', '.']
	29: ['+', 'x']
	30: ['v', '<', '^', '>']
	31: ['>>--->', ' >>--->', '  >>--->', '   >>--->', '    >>--->', '    <---<<', '   <---<<',
		'  <---<<', ' <---<<', '<---<<']
	32: ['|', '||', '|||', '||||', '|||||', '|||||||', '||||||||', '|||||||', '||||||', '|||||',
		'||||', '|||', '||', '|']
	33: ['[          ]', '[=         ]', '[==        ]', '[===       ]', '[====      ]',
		'[=====     ]', '[======    ]', '[=======   ]', '[========  ]', '[========= ]',
		'[==========]']
	34: ['(*---------)', '(-*--------)', '(--*-------)', '(---*------)', '(----*-----)',
		'(-----*----)', '(------*---)', '(-------*--)', '(--------*-)', '(---------*)']
	35: ['‚ñà‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí', '‚ñà‚ñà‚ñà‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí',
		'‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñí‚ñí‚ñí', '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñí',
		'‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà']
	36: ['[                    ]', '[=>                  ]', '[===>                ]',
		'[=====>              ]', '[======>             ]', '[========>           ]',
		'[==========>         ]', '[============>       ]', '[==============>     ]',
		'[================>   ]', '[==================> ]', '[===================>]']
	39: ['üåç', 'üåé', 'üåè']
	40: ['‚óú', '‚óù', '‚óû', '‚óü']
	41: ['‚¨í', '‚¨î', '‚¨ì', '‚¨ï']
	42: ['‚¨ñ', '‚¨ò', '‚¨ó', '‚¨ô']
	43: ['[>>>          >]', '[]>>>>        []', '[]  >>>>      []', '[]    >>>>    []',
		'[]      >>>>  []', '[]        >>>>[]', '[>>          >>]']
	44: ['‚ô†', '‚ô£', '‚ô•', '‚ô¶']
	45: ['‚ûû', '‚ûü', '‚û†', '‚û°', '‚û†', '‚ûü']
	46: ['  |  ', ' \\   ', '_    ', ' \\   ', '  |  ', '   / ', '    _', '   / ']
	47: ['  . . . .', '.   . . .', '. .   . .', '. . .   .', '. . . .  ', '. . . . .']
	48: [' |     ', '  /    ', '   _   ', '    \\  ', '     | ', '    \\  ', '   _   ', '  /    ']
	49: ['‚é∫', '‚éª', '‚éº', '‚éΩ', '‚éº', '‚éª']
	50: ['‚ñπ‚ñπ‚ñπ‚ñπ‚ñπ', '‚ñ∏‚ñπ‚ñπ‚ñπ‚ñπ', '‚ñπ‚ñ∏‚ñπ‚ñπ‚ñπ', '‚ñπ‚ñπ‚ñ∏‚ñπ‚ñπ',
		'‚ñπ‚ñπ‚ñπ‚ñ∏‚ñπ', '‚ñπ‚ñπ‚ñπ‚ñπ‚ñ∏']
	51: ['[    ]', '[   =]', '[  ==]', '[ ===]', '[====]', '[=== ]', '[==  ]', '[=   ]']
	52: ['( ‚óè    )', '(  ‚óè   )', '(   ‚óè  )', '(    ‚óè )', '(     ‚óè)', '(    ‚óè )',
		'(   ‚óè  )', '(  ‚óè   )', '( ‚óè    )']
	53: ['‚ú∂', '‚ú∏', '‚úπ', '‚ú∫', '‚úπ', '‚ú∑']
	54: ['‚ñê|\\____________‚ñå', '‚ñê_|\\___________‚ñå', '‚ñê__|\\__________‚ñå',
		'‚ñê___|\\_________‚ñå', '‚ñê____|\\________‚ñå', '‚ñê_____|\\_______‚ñå',
		'‚ñê______|\\______‚ñå', '‚ñê_______|\\_____‚ñå', '‚ñê________|\\____‚ñå',
		'‚ñê_________|\\___‚ñå', '‚ñê__________|\\__‚ñå', '‚ñê___________|\\_‚ñå',
		'‚ñê____________|\\‚ñå', '‚ñê____________/|‚ñå', '‚ñê___________/|_‚ñå',
		'‚ñê__________/|__‚ñå', '‚ñê_________/|___‚ñå', '‚ñê________/|____‚ñå',
		'‚ñê_______/|_____‚ñå', '‚ñê______/|______‚ñå', '‚ñê_____/|_______‚ñå',
		'‚ñê____/|________‚ñå', '‚ñê___/|_________‚ñå', '‚ñê__/|__________‚ñå',
		'‚ñê_/|___________‚ñå', '‚ñê/|____________‚ñå']
	55: ['‚ñê‚†Ç       ‚ñå', '‚ñê‚†à       ‚ñå', '‚ñê ‚†Ç      ‚ñå', '‚ñê ‚††      ‚ñå',
		'‚ñê  ‚°Ä     ‚ñå', '‚ñê  ‚††     ‚ñå', '‚ñê   ‚†Ç    ‚ñå', '‚ñê   ‚†à    ‚ñå',
		'‚ñê    ‚†Ç   ‚ñå', '‚ñê    ‚††   ‚ñå', '‚ñê     ‚°Ä  ‚ñå', '‚ñê     ‚††  ‚ñå',
		'‚ñê      ‚†Ç ‚ñå', '‚ñê      ‚†à ‚ñå', '‚ñê       ‚†Ç‚ñå', '‚ñê       ‚††‚ñå',
		'‚ñê       ‚°Ä‚ñå', '‚ñê      ‚†† ‚ñå', '‚ñê      ‚†Ç ‚ñå', '‚ñê     ‚†à  ‚ñå',
		'‚ñê     ‚†Ç  ‚ñå', '‚ñê    ‚††   ‚ñå', '‚ñê    ‚°Ä   ‚ñå', '‚ñê   ‚††    ‚ñå',
		'‚ñê   ‚†Ç    ‚ñå', '‚ñê  ‚†à     ‚ñå', '‚ñê  ‚†Ç     ‚ñå', '‚ñê ‚††      ‚ñå',
		'‚ñê ‚°Ä      ‚ñå', '‚ñê‚††       ‚ñå']
	56: ['¬ø', '?']
	57: ['‚¢π', '‚¢∫', '‚¢º', '‚£∏', '‚£á', '‚°ß', '‚°ó', '‚°è']
	58: ['‚¢Ñ', '‚¢Ç', '‚¢Å', '‚°Å', '‚°à', '‚°ê', '‚°†']
	59: ['.  ', '.. ', '...', ' ..', '  .', '   ']
	60: ['.', 'o', 'O', '¬∞', 'O', 'o', '.']
	61: ['‚ñì', '‚ñí', '‚ñë']
	62: ['‚ñå', '‚ñÄ', '‚ñê', '‚ñÑ']
	63: ['‚ä∂', '‚ä∑']
	64: ['‚ñ™', '‚ñ´']
	65: ['‚ñ°', '‚ñ†']
	66: ['‚ñÆ', '‚ñØ']
	67: ['-', '=', '‚â°']
	68: ['d', 'q', 'p', 'b']
	69: ['‚àô‚àô‚àô', '‚óè‚àô‚àô', '‚àô‚óè‚àô', '‚àô‚àô‚óè', '‚àô‚àô‚àô']
	70: ['üåë ', 'üåí ', 'üåì ', 'üåî ', 'üåï ', 'üåñ ', 'üåó ', 'üåò ']
	71: ['‚òó', '‚òñ']
	72: ['‚ßá', '‚ßÜ']
	73: ['‚óâ', '‚óé']
	74: ['„äÇ', '„äÄ', '„äÅ']
	75: ['‚¶æ', '‚¶ø']
	76: ['·Äù', '·ÅÄ']
	77: ['‚ñå', '‚ñÄ', '‚ñê‚ñÑ']
	78: ['‚†à‚†Å', '‚†à‚†ë', '‚†à‚†±', '‚†à‚°±', '‚¢Ä‚°±', '‚¢Ñ‚°±', '‚¢Ñ‚°±', '‚¢Ü‚°±', '‚¢é‚°±',
		'‚¢é‚°∞', '‚¢é‚°†', '‚¢é‚°Ä', '‚¢é‚†Å', '‚†é‚†Å', '‚†ä‚†Å']
	79: ['________', '-_______', '_-______', '__-_____', '___-____', '____-___', '_____-__',
		'______-_', '_______-', '________', '_______-', '______-_', '_____-__', '____-___',
		'___-____', '__-_____', '_-______', '-_______', '________']
	80: ['|_______', '_/______', '__-_____', '___\\____', '____|___', '_____/__', '______-_',
		'_______\\', '_______|', '______\\_', '_____-__', '____/___', '___|____', '__\\_____',
		'_-______']
	81: ['‚ñ°', '‚ó±', '‚óß', '‚ñ£', '‚ñ†']
	82: ['‚ñ°', '‚ó±', '‚ñ®', '‚ñ©', '‚ñ†']
	83: ['‚ñë', '‚ñí', '‚ñì', '‚ñà']
	84: ['‚ñë', '‚ñà']
	85: ['‚ö™', '‚ö´']
	86: ['‚óØ', '‚¨§']
	87: ['‚ñ±', '‚ñ∞']
	88: ['‚ûä', '‚ûã', '‚ûå', '‚ûç', '‚ûé', '‚ûè', '‚ûê', '‚ûë', '‚ûí', '‚ûì']
	89: ['¬Ω', '‚Öì', '‚Öî', '¬º', '¬æ', '‚Öõ', '‚Öú', '‚Öù', '‚Öû']
	90: ['‚Üû', '‚Üü', '‚Ü†', '‚Ü°']
}
